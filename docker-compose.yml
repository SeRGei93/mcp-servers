services:
  redis:
    image: redis:7-alpine
    container_name: searxng-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5

  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    environment:
      SEARXNG_BASE_URL: "http://localhost:8080/"
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./searxng/settings.yml:/etc/searxng/settings.yml
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - 'http://localhost:8080/search?q=test&format=json' > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  web-search-mcp:
    build:
      context: ./web-search
      dockerfile: Dockerfile
    container_name: web-search-mcp-server
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      PORT: "${PORT:-3000}"
      SEARXNG_URL: "http://searxng:8080"
      SEARXNG_ENGINES: "google,yandex"
      SEARXNG_TIMEOUT_MS: "12000"
      SEARXNG_RETRIES: "2"
      SEARXNG_RETRY_BACKOFF_MS: "350"
      SEARXNG_CATEGORIES: "general"
      RATE_LIMIT_PER_SECOND: "20"
      RATE_LIMIT_PER_MONTH: "15000"
    depends_on:
      searxng:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"const p=process.env.PORT||3000;fetch('http://localhost:'+p+'/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
